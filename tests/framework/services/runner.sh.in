#!/bin/bash -ex

yum install -y epel-release
yum clean all
yum install -y https://download.postgresql.org/pub/repos/yum/reporpms/EL-7-x86_64/pgdg-redhat-repo-latest.noarch.rpm
yum install -y git python-virtualenv python-setuptools python-devel gcc make graphviz-devel postgresql96-server postgresql96-contrib telnet python-ethtool erlang-inets patch gcc-c++ systemd-devel python-pip python2-pbr curl libcurl-devel nss openssl-devel cargo

yum-config-manager --add-repo https://copr.fedorainfracloud.org/coprs/@MFL_COPR_REPO@/repo/epel-7/@MFL_COPR_NAME@-epel-7.repo
yum -y install ed npm nginx libuv iml-gui iml-online-help rust-iml-api

cp iml-corosync.service iml-gunicorn.service iml-http-agent.service iml-job-scheduler.service /lib/systemd/system
cp iml-lustre-audit.service iml-manager.target iml-plugin-runner.service iml-power-control.service /lib/systemd/system
cp iml-settings-populator.service /lib/systemd/system
pip install -r requirements.txt
pip install -r requirements.test
echo -e "/^DEBUG =/s/= .*$/= True/\nwq" | ed settings.py

rsync -ar --exclude='.cargo' --exclude='iml-gui/node_modules' ./ /usr/share/chroma-manager
mkdir /var/log/chroma
cd /usr/share/chroma-manager

CARGO_NET_RETRY=25 cargo install sqlx-cli --no-default-features --features postgres --git https://github.com/jgrund/sqlx --branch workspace-support
echo "DATABASE_URL=postgres://chroma@localhost:5432/chroma" > .env
python ./manage.py dev_setup
cargo sqlx migrate run

env CARGO_NET_RETRY=25 $(python manage.py print-settings 2> /dev/null | xargs) cargo run --bin iml-config nginx generate-config --path ./chroma-manager.conf.template --output /etc/nginx/conf.d/chroma-manager.conf
systemctl start iml-api

PYTHONPATH=. nosetests tests/services/ --stop
