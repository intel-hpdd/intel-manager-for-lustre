include ../include/Makefile.distro
include ../include/Makefile.lustre_build_meta

include $(INCLUDE_DIR)/Makefile.zfs_version-$(DISTRO)
LUSTRE_KERNEL_RELEASE	 = $(KERNEL_RELEASE)_lustre.x86_64

override REPO           := $(dir $(patsubst %/,%,$(REPO)))/repo-lustre

CHROMA_EXTERNALS_SUBDIR := zfs
SRC_REPO		:= $(JENKINS_ROOT_URL)/job/$(JENKINS_JOB_NAME)/$(JENKINS_BUILD_NUMBER)/arch=x86_64,build_type=server,distro=$(DISTRO),ib_stack=inkernel/artifact/artifacts
ALL_RPMS		:= zfs-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm        \
			   zfs-dkms-$(ZFS_RELEASE).$(DISTRO_TAG).noarch.rpm   \
			   spl-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm        \
			   spl-dkms-$(ZFS_RELEASE).$(DISTRO_TAG).noarch.rpm   \
			   libnvpair1-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm \
			   libuutil1-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm  \
			   libzfs2-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm    \
			   libzpool2-$(ZFS_RELEASE).$(DISTRO_TAG).x86_64.rpm

NO_REQUIREMENT		:= zfs zfs-dkms spl spl-dkms              \
			   libnvpair1 libuutil1 libzfs2 libzpool2

$(INCLUDE_DIR)/Makefile.zfs_version-$(DISTRO): $(INCLUDE_DIR)/Makefile.lustre_build_meta.md5
	# any of this is only needed by make download
	set -e;                                                                                      \
	if [ "$(MAKECMDGOALS)" != "download" ]; then                                                 \
	    touch $@;                                                                                \
	    exit 0;                                                                                  \
	fi;                                                                                          \
	if [ ! -d $(LIB_DIR)/jenkinsapi-$(JENKINSAPI_VERSION) ]; then                                \
	    mkdir -p $(LIB_DIR);                                                                     \
	    rm -rf $(LIB_DIR)/jenkinsapi-[0-9]*;                                                     \
	    tar -C $(LIB_DIR) -xzvf $(CHROMA_EXTERNALS_TOP)/jenkinsapi-$(JENKINSAPI_VERSION).tar.gz; \
	fi;                                                                                          \
	{ echo "# This file is automatically generated.  DO NOT update manually.";                   \
	echo "";                                                                                     \
	echo "ZFS_RELEASE :=    $(shell $(INCLUDE_DIR)/jenkinsapi $(JENKINS_ROOT_URL)                \
				$(JENKINS_USERNAME) $(JENKINS_PASSWORD) $(JENKINS_JOB_NAME)          \
				$(JENKINS_BUILD_NUMBER) $(DISTRO) get_zfs_ver)"; } > $@;             \
	if git status --porcelain $@ | grep -q ^??; then                                             \
	    git add $@;                                                                              \
	fi

include ../include/Makefile.fetch-from-repo

# we don't actually want to do anything with these SRPMS except download
# it to chroma-externals
all rpms $(SPECNAME):
	echo "Nothing to do here for $@"
